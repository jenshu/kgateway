# EP-10943: Route Delegation

* Issue: [#10943](https://github.com/kgateway-dev/kgateway/issues/10943)

## Background

Route delegation is a feature that allows HTTPRoutes to delegate routing configuration to other HTTPRoutes. Benefits include:
- Improving maintanability by splitting up large routing configurations into multiple smaller objects.
- Being able to enforce a set of policies at the top level, but delegating custom routing decisions and policies to different teams.
- Allowing teams to make changes to their routing configuration without accessing or impacting routing owned by other teams.
- Reducing duplication by being able to reuse the same routing configuration in multiple places.

## Motivation

### Goals

The purpose of this EP is to define the current kgateway route delegation feature, including the API and implementation, at the time of this writing. This includes topics such as:
- Path matching
- Header, query parameter, and method matching
- Delegating by wildcard name
- Multiple children, multiple parents, and multiple levels of delegation
- Restricting allowed parents using parentRefs
- Matcher inheritance
- TrafficPolicy inheritance
- Error cases

### Non-Goals

The EP will not address or propose new features / enhancements to route delegation, such as:
- Delegation with native HTTPRouteRule fields such as `timeouts` and `retry`
- Delegating by wildcard namespace
- Delegating by label
- TrafficPolicy merging
- Supporting delegation for route types other than HTTPRoutes (e.g. TCPRoute, TLSRoutes)

## API and examples

Route delegation is configured through the `backendRefs` field in HTTPRoute rules, where a backend reference can point to other HTTPRoutes.

### Basic path matching

In the simplest case, a parent route can delegate configuration for a specific path prefix to a child by reference. In the following example, the route `parent` delegates to the route `child-route` in namespace `team1` for paths starting with `/team1`:

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: parent
  namespace: infra
spec:
  parentRefs:
  - name: example-gateway
  hostnames:
  - "example.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: child-route
      namespace: team1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: child-route
  namespace: team1
spec:
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1/anything
    backendRefs:
    - name: team1-svc
      port: 8080
```

### Wildcard child name

The child route name can also be a wildcard. In this case, the parent will delegate `/team1` to all routes in the `team1` namespace (i.e. both `child-route1` and `child-route2`):

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: parent
  namespace: infra
spec:
  parentRefs:
  - name: example-gateway
  hostnames:
  - "example.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: *
      namespace: team1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: child-route1
  namespace: team1
spec:
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1/foo
    backendRefs:
    - name: svc1
      port: 8080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: child-route2
  namespace: team1
spec:
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1/bar
    backendRefs:
    - name: svc2
      port: 8080
```

### Multiple children

A parent route can delegate different paths to different children or namespaces:

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: parent
  namespace: infra
spec:
  parentRefs:
  - name: example-gateway
  hostnames:
  - "example.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: *
      namespace: team1
  - matches:
    - path:
        type: PathPrefix
        value: /team2
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: *
      namespace: team2
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: child-route1
  namespace: team1
spec:
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1/foo
    backendRefs:
    - name: svc1
      port: 8080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: child-route2
  namespace: team2
spec:
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team2/bar
    backendRefs:
    - name: svc2
      port: 8080
```

### Multiple parents

Multiple parents can delegate to the same child:

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: parent-foo
  namespace: infra
spec:
  parentRefs:
  - name: example-gateway
  hostnames:
  - "foo.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: "*"
      namespace: team1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: parent-bar
  namespace: infra
spec:
  parentRefs:
  - name: example-gateway
  hostnames:
  - "bar.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: "*"
      namespace: team1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: child-route
  namespace: team1
spec:
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1/anything
    backendRefs:
    - name: team1-svc
      port: 8080
```

### ParentRefs on children

Children may restrict which parent routes are allowed to delegate to it, by specifying `parentRefs`. In the following example, although both `parent-foo` and `parent-bar` delegate to `child-route`, `child-route` has restricted the allowed parents to only `parent-foo` via the `parentRefs` field:

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: parent-foo
  namespace: infra
spec:
  parentRefs:
  - name: example-gateway
  hostnames:
  - "foo.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: "*"
      namespace: team1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: parent-bar
  namespace: infra
spec:
  parentRefs:
  - name: example-gateway
  hostnames:
  - "bar.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1
    backendRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: "*"
      namespace: team1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: child-route
  namespace: team1
spec:
  parentRefs:
  - name: parent-foo
    namespace: infra
    group: gateway.networking.k8s.io
    kind: HTTPRoute
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /team1/anything
    backendRefs:
    - name: team1-svc
      port: 8080
```

If a child doesn't specify `parentRefs`, then any parent is allowed to delegate to it.

Note that `parentRefs` on the child alone will not enable delegation. A parent still needs to enable delegation to the child, via the `backendRefs` field.

### Header / query param / method matching

TODO

### Multiple levels of delegation

TODO

### Matcher inheritance

TODO
When a child route has the annotation `delegation.kgateway.dev/inherit-parent-matcher: true`, this enables merging of parent/child matchers as follows:

### Policy inheritance

TODO
TrafficPolicies...

## Delegation rules

TODO
There are several rules that must be followed when using delegation. Any route that violates one of these rules will be removed from the translated output.
- Child HTTPRoutes may not set the `spec.hostnames` field, as the hostnames are inherited from the parent.
- Parent routes must use `PathPrefix`
- No cycles...

#### Without matcher inheritance

- child method must be same as parent

#### With matcher inheritance

## Implementation Details

### Reconciling route tree

The translation for route delegation is done during the first phase of kgateway translation, which converts user-facing configuration (Gateways, HTTPRoutes, TrafficPolicies) into a GatewayIR (intermediate representation). The entrypoint to this translation is the `Translate` function in [gateway_translator.go](/internal/kgateway/translator/gateway/gateway_translator.go).

When it gets to translating the HTTPRoutes, the delegated routes are recursively visited to create a flattened list of routes. This is initiated from the `flattenDelegatedRoutes` function of [delegation.go](/internal/kgateway/translator/httproute/delegation.go):
- If a child route cannot be fetched, this function returns an error.
- If the child route is invalid (right now we only validate that it doesn't specify hostnames), or if there is a cycle in the delegation tree, the child route will be ignored/dropped, and its Status updated with the reason.

For each child route that is visited, `filterDelegatedChildren` in [delegation_helpers.go](/internal/kgateway/translator/httproute/delegation_helpers.go) is called. This has most of the logic to check the validity of parent/child relationships and to do any necesssary matcher merging.

Also during this phase of translation when HTTPRoutes/HTTPRouteRules are converted into their IRs, the list of all policies targeting that route/rule are fetched and stored on the IR. See `transformHttpRoute` in [policy.go](/internal/kgateway/krtcollections/policy.go).

### Applying policies to routes

During the second phase of translation, the IRs are converted to xDS configuration. The entrypoint to this translation is the `Translate` function in [irtranslator/gateway.go](/internal/kgateway/translator/irtranslator/gateway.go). This is when each of the attached policies, including those inherited through delegation, are collected and applied to the route (via a plugin translation pass calling `ApplyForRoute`) to form the final envoy configuration. See `runRoutePlugins` in [irtranslator/route.go](/internal/kgateway/translator/irtranslator/route.go) for the route translation.

The policies are applied to the route in the following order, with the latest policy taking precedence (i.e. overwriting previous ones):
1. HTTPRoute policies attached via targetRef
1. HTTPRouteRule policies attached via targetRef
1. HTTPRouteRule policies attached via extensionRef
1. delegate parent HTTPRoute policies attached via targetRef
1. delegate parent HTTPRouteRule policies attached via targetRef
1. delegate parent HTTPRouteRule policies attached via extensionRef

### Test Plan

We currently have tests that cover a broad range of route delegation scenarios, primarily in the following suites:
- [Translation unit tests](/internal/kgateway/translator/gateway/gateway_translator_test.go) (see the `Route Delegation translator` tests), which assert that given some input (Gateways, HTTPRoutes, Services) we get the correct translated output (i.e. Envoy config)
- [End-to-end tests](/test/kubernetes/e2e/features/route_delegation/suite.go), which contain various route delegation configurations and assert the expected statuses and curl responses on the routes.

## Alternatives

N/A

## Open Questions

N/A